ARM GAS  /tmp/ccklse9U.s 			page 1


   1              		.cpu cortex-m4
   2              		.eabi_attribute 27, 1
   3              		.eabi_attribute 28, 1
   4              		.eabi_attribute 20, 1
   5              		.eabi_attribute 21, 1
   6              		.eabi_attribute 23, 3
   7              		.eabi_attribute 24, 1
   8              		.eabi_attribute 25, 1
   9              		.eabi_attribute 26, 1
  10              		.eabi_attribute 30, 1
  11              		.eabi_attribute 34, 1
  12              		.eabi_attribute 18, 4
  13              		.file	"calibration.c"
  14              		.text
  15              	.Ltext0:
  16              		.cfi_sections	.debug_frame
  17              		.section	.rodata.order_phases.str1.4,"aMS",%progbits,1
  18              		.align	2
  19              	.LC0:
  20 0000 43686563 		.ascii	"Checking phase sign, pole pairs\015\000"
  20      6B696E67 
  20      20706861 
  20      73652073 
  20      69676E2C 
  21              		.global	__aeabi_f2d
  22              		.global	__aeabi_d2uiz
  23 0021 000000   		.align	2
  24              	.LC1:
  25 0024 50686173 		.ascii	"Phase order correct\015\000"
  25      65206F72 
  25      64657220 
  25      636F7272 
  25      6563740D 
  26 0039 000000   		.align	2
  27              	.LC2:
  28 003c 53776170 		.ascii	"Swapping phase sign\015\000"
  28      70696E67 
  28      20706861 
  28      73652073 
  28      69676E0D 
  29 0051 000000   		.align	2
  30              	.LC3:
  31 0054 506F6C65 		.ascii	"Pole Pairs: %d\015\012\000"
  31      20506169 
  31      72733A20 
  31      25640D0A 
  31      00
  32 0065 000000   		.align	2
  33              	.LC4:
  34 0068 53746172 		.ascii	"Start: %.3f   End: %.3f\015\012\000"
  34      743A2025 
  34      2E336620 
  34      2020456E 
  34      643A2025 
  35              		.section	.text.order_phases,"ax",%progbits
  36              		.align	1
  37              		.global	order_phases
ARM GAS  /tmp/ccklse9U.s 			page 2


  38              		.arch armv7e-m
  39              		.syntax unified
  40              		.thumb
  41              		.thumb_func
  42              		.fpu fpv4-sp-d16
  44              	order_phases:
  45              	.LVL0:
  46              	.LFB238:
  47              		.file 1 "Core/Src/calibration.c"
   1:Core/Src/calibration.c **** /*
   2:Core/Src/calibration.c ****  * calibration.c
   3:Core/Src/calibration.c ****  *
   4:Core/Src/calibration.c ****  *  Created on: Aug 11, 2020
   5:Core/Src/calibration.c ****  *      Author: ben
   6:Core/Src/calibration.c ****  */
   7:Core/Src/calibration.c **** 
   8:Core/Src/calibration.c **** 
   9:Core/Src/calibration.c **** #include "calibration.h"
  10:Core/Src/calibration.c **** #include "hw_config.h"
  11:Core/Src/calibration.c **** #include "user_config.h"
  12:Core/Src/calibration.c **** #include <stdio.h>
  13:Core/Src/calibration.c **** #include <stdlib.h>
  14:Core/Src/calibration.c **** #include "usart.h"
  15:Core/Src/calibration.c **** #include "math_ops.h"
  16:Core/Src/calibration.c **** 
  17:Core/Src/calibration.c **** void order_phases(EncoderStruct *encoder, ControllerStruct *controller, CalStruct * cal, int loop_c
  48              		.loc 1 17 105 view -0
  49              		.cfi_startproc
  50              		@ args = 0, pretend = 0, frame = 0
  51              		@ frame_needed = 0, uses_anonymous_args = 0
  52              		.loc 1 17 105 is_stmt 0 view .LVU1
  53 0000 F0B5     		push	{r4, r5, r6, r7, lr}
  54              	.LCFI0:
  55              		.cfi_def_cfa_offset 20
  56              		.cfi_offset 4, -20
  57              		.cfi_offset 5, -16
  58              		.cfi_offset 6, -12
  59              		.cfi_offset 7, -8
  60              		.cfi_offset 14, -4
  61 0002 2DED028B 		vpush.64	{d8}
  62              	.LCFI1:
  63              		.cfi_def_cfa_offset 28
  64              		.cfi_offset 80, -28
  65              		.cfi_offset 81, -24
  66 0006 83B0     		sub	sp, sp, #12
  67              	.LCFI2:
  68              		.cfi_def_cfa_offset 40
  69 0008 0746     		mov	r7, r0
  70 000a 0E46     		mov	r6, r1
  71 000c 1546     		mov	r5, r2
  72 000e 1C46     		mov	r4, r3
  18:Core/Src/calibration.c **** 	/* Checks phase order, to ensure that positive Q current produces
  19:Core/Src/calibration.c **** 	   torque in the positive direction wrt the position sensor */
  20:Core/Src/calibration.c **** 	PHASE_ORDER = 0;
  73              		.loc 1 20 2 is_stmt 1 view .LVU2
  74              		.loc 1 20 14 is_stmt 0 view .LVU3
  75 0010 554B     		ldr	r3, .L21
ARM GAS  /tmp/ccklse9U.s 			page 3


  76              	.LVL1:
  77              		.loc 1 20 14 view .LVU4
  78 0012 0022     		movs	r2, #0
  79              	.LVL2:
  80              		.loc 1 20 14 view .LVU5
  81 0014 1A60     		str	r2, [r3]
  21:Core/Src/calibration.c **** 
  22:Core/Src/calibration.c **** 	if(!cal->started){
  82              		.loc 1 22 2 is_stmt 1 view .LVU6
  83              		.loc 1 22 9 is_stmt 0 view .LVU7
  84 0016 2B7C     		ldrb	r3, [r5, #16]	@ zero_extendqisi2
  85              		.loc 1 22 4 view .LVU8
  86 0018 002B     		cmp	r3, #0
  87 001a 69D0     		beq	.L18
  88              	.LVL3:
  89              	.L2:
  23:Core/Src/calibration.c **** 		printf("Checking phase sign, pole pairs\r\n");
  24:Core/Src/calibration.c **** 		cal->started = 1;
  25:Core/Src/calibration.c **** 		cal->start_count = loop_count;
  26:Core/Src/calibration.c **** 	}
  27:Core/Src/calibration.c **** 	cal->time = (float)(loop_count - cal->start_count)*DT;
  90              		.loc 1 27 2 is_stmt 1 view .LVU9
  91              		.loc 1 27 38 is_stmt 0 view .LVU10
  92 001c EB68     		ldr	r3, [r5, #12]
  93              		.loc 1 27 33 view .LVU11
  94 001e E31A     		subs	r3, r4, r3
  95 0020 07EE903A 		vmov	s15, r3	@ int
  96              		.loc 1 27 14 view .LVU12
  97 0024 F8EEE77A 		vcvt.f32.s32	s15, s15
  98              		.loc 1 27 52 view .LVU13
  99 0028 9FED507A 		vldr.32	s14, .L21+4
 100 002c 67EE877A 		vmul.f32	s15, s15, s14
 101              		.loc 1 27 12 view .LVU14
 102 0030 C5ED057A 		vstr.32	s15, [r5, #20]
  28:Core/Src/calibration.c **** 
  29:Core/Src/calibration.c ****     if(cal->time < T1){
 103              		.loc 1 29 5 is_stmt 1 view .LVU15
 104              		.loc 1 29 7 is_stmt 0 view .LVU16
 105 0034 B7EE007A 		vmov.f32	s14, #1.0e+0
 106 0038 F4EEC77A 		vcmpe.f32	s15, s14
 107 003c F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 108 0040 5DD4     		bmi	.L19
  30:Core/Src/calibration.c ****         // Set voltage angle to zero, wait for rotor position to settle
  31:Core/Src/calibration.c ****         cal->theta_ref = 0;//W_CAL*cal->time;
  32:Core/Src/calibration.c ****         cal->cal_position.elec_angle = cal->theta_ref;
  33:Core/Src/calibration.c ****         cal->cal_position.elec_velocity = 0;
  34:Core/Src/calibration.c ****         controller->i_d_des = I_CAL;
  35:Core/Src/calibration.c ****         controller->i_q_des = 0.0f;
  36:Core/Src/calibration.c ****         commutate(controller, &cal->cal_position);
  37:Core/Src/calibration.c ****     	cal->theta_start = encoder->angle_multiturn[0];
  38:Core/Src/calibration.c ****     	return;
  39:Core/Src/calibration.c ****     }
  40:Core/Src/calibration.c **** 
  41:Core/Src/calibration.c ****     else if(cal->time < T1+2.0f*PI_F/W_CAL){
 109              		.loc 1 41 10 is_stmt 1 view .LVU17
 110              		.loc 1 41 12 is_stmt 0 view .LVU18
 111 0042 9FED4B7A 		vldr.32	s14, .L21+8
ARM GAS  /tmp/ccklse9U.s 			page 4


 112 0046 F4EEC77A 		vcmpe.f32	s15, s14
 113 004a F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 114 004e 6FD4     		bmi	.L20
  42:Core/Src/calibration.c ****     	// rotate voltage vector through one electrical cycle
  43:Core/Src/calibration.c ****     	cal->theta_ref = W_CAL*(cal->time-T1);
  44:Core/Src/calibration.c ****     	cal->cal_position.elec_angle = cal->theta_ref;
  45:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
  46:Core/Src/calibration.c ****     	return;
  47:Core/Src/calibration.c ****     }
  48:Core/Src/calibration.c **** 
  49:Core/Src/calibration.c **** 	reset_foc(controller);
 115              		.loc 1 49 2 is_stmt 1 view .LVU19
 116 0050 3046     		mov	r0, r6
 117 0052 FFF7FEFF 		bl	reset_foc
 118              	.LVL4:
  50:Core/Src/calibration.c **** 
  51:Core/Src/calibration.c **** 	float theta_end = encoder->angle_multiturn[0];
 119              		.loc 1 51 2 view .LVU20
 120              		.loc 1 51 8 is_stmt 0 view .LVU21
 121 0056 97ED038A 		vldr.32	s16, [r7, #12]
 122              	.LVL5:
  52:Core/Src/calibration.c **** 	cal->ppairs = round(2.0f*PI_F/fabsf(theta_end-cal->theta_start));
 123              		.loc 1 52 2 is_stmt 1 view .LVU22
 124              		.loc 1 52 51 is_stmt 0 view .LVU23
 125 005a D5ED068A 		vldr.32	s17, [r5, #24]
 126              		.loc 1 52 47 view .LVU24
 127 005e 78EE687A 		vsub.f32	s15, s16, s17
 128              		.loc 1 52 32 view .LVU25
 129 0062 F0EEE77A 		vabs.f32	s15, s15
 130              		.loc 1 52 16 view .LVU26
 131 0066 9FED437A 		vldr.32	s14, .L21+12
 132 006a C7EE277A 		vdiv.f32	s15, s14, s15
 133 006e 17EE900A 		vmov	r0, s15
 134 0072 FFF7FEFF 		bl	__aeabi_f2d
 135              	.LVL6:
 136 0076 41EC100B 		vmov	d0, r0, r1
 137 007a FFF7FEFF 		bl	round
 138              	.LVL7:
 139 007e 51EC100B 		vmov	r0, r1, d0
 140              		.loc 1 52 14 view .LVU27
 141 0082 FFF7FEFF 		bl	__aeabi_d2uiz
 142              	.LVL8:
 143 0086 2870     		strb	r0, [r5]
  53:Core/Src/calibration.c **** 
  54:Core/Src/calibration.c **** 	if(cal->theta_start < theta_end){
 144              		.loc 1 54 2 is_stmt 1 view .LVU28
 145              		.loc 1 54 4 is_stmt 0 view .LVU29
 146 0088 F4EEC88A 		vcmpe.f32	s17, s16
 147 008c F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 148 0090 63D5     		bpl	.L16
  55:Core/Src/calibration.c **** 		cal->phase_order = 0;
 149              		.loc 1 55 3 is_stmt 1 view .LVU30
 150              		.loc 1 55 20 is_stmt 0 view .LVU31
 151 0092 0023     		movs	r3, #0
 152 0094 85F82030 		strb	r3, [r5, #32]
  56:Core/Src/calibration.c **** 		printf("Phase order correct\r\n");
 153              		.loc 1 56 3 is_stmt 1 view .LVU32
ARM GAS  /tmp/ccklse9U.s 			page 5


 154 0098 3748     		ldr	r0, .L21+16
 155 009a FFF7FEFF 		bl	puts
 156              	.LVL9:
 157              	.L10:
  57:Core/Src/calibration.c **** 	}
  58:Core/Src/calibration.c **** 	else{
  59:Core/Src/calibration.c **** 		cal->phase_order = 1;
  60:Core/Src/calibration.c **** 		printf("Swapping phase sign\r\n");
  61:Core/Src/calibration.c **** 	}
  62:Core/Src/calibration.c ****     printf("Pole Pairs: %d\r\n", cal->ppairs);
 158              		.loc 1 62 5 view .LVU33
 159 009e 2978     		ldrb	r1, [r5]	@ zero_extendqisi2
 160 00a0 3648     		ldr	r0, .L21+20
 161 00a2 FFF7FEFF 		bl	printf
 162              	.LVL10:
  63:Core/Src/calibration.c ****     printf("Start: %.3f   End: %.3f\r\n", cal->theta_start, theta_end);
 163              		.loc 1 63 5 view .LVU34
 164 00a6 A869     		ldr	r0, [r5, #24]	@ float
 165 00a8 FFF7FEFF 		bl	__aeabi_f2d
 166              	.LVL11:
 167 00ac 0646     		mov	r6, r0
 168              	.LVL12:
 169              		.loc 1 63 5 is_stmt 0 view .LVU35
 170 00ae 0F46     		mov	r7, r1
 171              	.LVL13:
 172              		.loc 1 63 5 view .LVU36
 173 00b0 18EE100A 		vmov	r0, s16
 174 00b4 FFF7FEFF 		bl	__aeabi_f2d
 175              	.LVL14:
 176 00b8 CDE90001 		strd	r0, [sp]
 177 00bc 3246     		mov	r2, r6
 178 00be 3B46     		mov	r3, r7
 179 00c0 2F48     		ldr	r0, .L21+24
 180 00c2 FFF7FEFF 		bl	printf
 181              	.LVL15:
  64:Core/Src/calibration.c ****     PHASE_ORDER = cal->phase_order;
 182              		.loc 1 64 5 is_stmt 1 view .LVU37
 183              		.loc 1 64 22 is_stmt 0 view .LVU38
 184 00c6 95F82020 		ldrb	r2, [r5, #32]	@ zero_extendqisi2
 185              		.loc 1 64 17 view .LVU39
 186 00ca 274B     		ldr	r3, .L21
 187 00cc 1A60     		str	r2, [r3]
  65:Core/Src/calibration.c ****     PPAIRS = (float)cal->ppairs;
 188              		.loc 1 65 5 is_stmt 1 view .LVU40
 189              		.loc 1 65 24 is_stmt 0 view .LVU41
 190 00ce 2B78     		ldrb	r3, [r5]	@ zero_extendqisi2
 191 00d0 07EE903A 		vmov	s15, r3	@ int
 192              		.loc 1 65 14 view .LVU42
 193 00d4 F8EE677A 		vcvt.f32.u32	s15, s15
 194              		.loc 1 65 12 view .LVU43
 195 00d8 2A4B     		ldr	r3, .L21+28
 196 00da C3ED0A7A 		vstr.32	s15, [r3, #40]
  66:Core/Src/calibration.c ****     cal->started = 0;
 197              		.loc 1 66 5 is_stmt 1 view .LVU44
 198              		.loc 1 66 18 is_stmt 0 view .LVU45
 199 00de 0023     		movs	r3, #0
 200 00e0 2B74     		strb	r3, [r5, #16]
ARM GAS  /tmp/ccklse9U.s 			page 6


  67:Core/Src/calibration.c ****     cal->done_ordering = 1;	// Finished checking phase order
 201              		.loc 1 67 5 is_stmt 1 view .LVU46
 202              		.loc 1 67 24 is_stmt 0 view .LVU47
 203 00e2 0123     		movs	r3, #1
 204 00e4 85F82130 		strb	r3, [r5, #33]
 205              	.LVL16:
 206              	.L1:
  68:Core/Src/calibration.c **** }
 207              		.loc 1 68 1 view .LVU48
 208 00e8 03B0     		add	sp, sp, #12
 209              	.LCFI3:
 210              		.cfi_remember_state
 211              		.cfi_def_cfa_offset 28
 212              		@ sp needed
 213 00ea BDEC028B 		vldm	sp!, {d8}
 214              	.LCFI4:
 215              		.cfi_restore 80
 216              		.cfi_restore 81
 217              		.cfi_def_cfa_offset 20
 218 00ee F0BD     		pop	{r4, r5, r6, r7, pc}
 219              	.LVL17:
 220              	.L18:
 221              	.LCFI5:
 222              		.cfi_restore_state
  23:Core/Src/calibration.c **** 		cal->started = 1;
 223              		.loc 1 23 3 is_stmt 1 view .LVU49
 224 00f0 2548     		ldr	r0, .L21+32
 225              	.LVL18:
  23:Core/Src/calibration.c **** 		cal->started = 1;
 226              		.loc 1 23 3 is_stmt 0 view .LVU50
 227 00f2 FFF7FEFF 		bl	puts
 228              	.LVL19:
  24:Core/Src/calibration.c **** 		cal->start_count = loop_count;
 229              		.loc 1 24 3 is_stmt 1 view .LVU51
  24:Core/Src/calibration.c **** 		cal->start_count = loop_count;
 230              		.loc 1 24 16 is_stmt 0 view .LVU52
 231 00f6 0123     		movs	r3, #1
 232 00f8 2B74     		strb	r3, [r5, #16]
  25:Core/Src/calibration.c **** 	}
 233              		.loc 1 25 3 is_stmt 1 view .LVU53
  25:Core/Src/calibration.c **** 	}
 234              		.loc 1 25 20 is_stmt 0 view .LVU54
 235 00fa EC60     		str	r4, [r5, #12]
 236 00fc 8EE7     		b	.L2
 237              	.L19:
  31:Core/Src/calibration.c ****         cal->cal_position.elec_angle = cal->theta_ref;
 238              		.loc 1 31 9 is_stmt 1 view .LVU55
  31:Core/Src/calibration.c ****         cal->cal_position.elec_angle = cal->theta_ref;
 239              		.loc 1 31 24 is_stmt 0 view .LVU56
 240 00fe 0023     		movs	r3, #0
 241 0100 AB60     		str	r3, [r5, #8]	@ float
  32:Core/Src/calibration.c ****         cal->cal_position.elec_velocity = 0;
 242              		.loc 1 32 9 is_stmt 1 view .LVU57
  32:Core/Src/calibration.c ****         cal->cal_position.elec_velocity = 0;
 243              		.loc 1 32 38 is_stmt 0 view .LVU58
 244 0102 05F50242 		add	r2, r5, #33280
 245 0106 C2F88830 		str	r3, [r2, #136]	@ float
ARM GAS  /tmp/ccklse9U.s 			page 7


  33:Core/Src/calibration.c ****         controller->i_d_des = I_CAL;
 246              		.loc 1 33 9 is_stmt 1 view .LVU59
  33:Core/Src/calibration.c ****         controller->i_d_des = I_CAL;
 247              		.loc 1 33 41 is_stmt 0 view .LVU60
 248 010a 05F50242 		add	r2, r5, #33280
 249 010e C2F89030 		str	r3, [r2, #144]	@ float
  34:Core/Src/calibration.c ****         controller->i_q_des = 0.0f;
 250              		.loc 1 34 9 is_stmt 1 view .LVU61
  34:Core/Src/calibration.c ****         controller->i_q_des = 0.0f;
 251              		.loc 1 34 31 is_stmt 0 view .LVU62
 252 0112 1C4A     		ldr	r2, .L21+28
 253 0114 926C     		ldr	r2, [r2, #72]	@ float
  34:Core/Src/calibration.c ****         controller->i_q_des = 0.0f;
 254              		.loc 1 34 29 view .LVU63
 255 0116 C6F8AC20 		str	r2, [r6, #172]	@ float
  35:Core/Src/calibration.c ****         commutate(controller, &cal->cal_position);
 256              		.loc 1 35 9 is_stmt 1 view .LVU64
  35:Core/Src/calibration.c ****         commutate(controller, &cal->cal_position);
 257              		.loc 1 35 29 is_stmt 0 view .LVU65
 258 011a C6F8B030 		str	r3, [r6, #176]	@ float
  36:Core/Src/calibration.c ****     	cal->theta_start = encoder->angle_multiturn[0];
 259              		.loc 1 36 9 is_stmt 1 view .LVU66
 260 011e 05F50241 		add	r1, r5, #33280
 261 0122 2C31     		adds	r1, r1, #44
 262 0124 3046     		mov	r0, r6
 263 0126 FFF7FEFF 		bl	commutate
 264              	.LVL20:
  37:Core/Src/calibration.c ****     	return;
 265              		.loc 1 37 6 view .LVU67
  37:Core/Src/calibration.c ****     	return;
 266              		.loc 1 37 49 is_stmt 0 view .LVU68
 267 012a FB68     		ldr	r3, [r7, #12]	@ float
  37:Core/Src/calibration.c ****     	return;
 268              		.loc 1 37 23 view .LVU69
 269 012c AB61     		str	r3, [r5, #24]	@ float
  38:Core/Src/calibration.c ****     }
 270              		.loc 1 38 6 is_stmt 1 view .LVU70
 271 012e DBE7     		b	.L1
 272              	.L20:
  43:Core/Src/calibration.c ****     	cal->cal_position.elec_angle = cal->theta_ref;
 273              		.loc 1 43 6 view .LVU71
  43:Core/Src/calibration.c ****     	cal->cal_position.elec_angle = cal->theta_ref;
 274              		.loc 1 43 39 is_stmt 0 view .LVU72
 275 0130 B7EE007A 		vmov.f32	s14, #1.0e+0
 276 0134 77EEC77A 		vsub.f32	s15, s15, s14
  43:Core/Src/calibration.c ****     	cal->cal_position.elec_angle = cal->theta_ref;
 277              		.loc 1 43 28 view .LVU73
 278 0138 B2EE047A 		vmov.f32	s14, #1.0e+1
 279 013c 67EE877A 		vmul.f32	s15, s15, s14
  43:Core/Src/calibration.c ****     	cal->cal_position.elec_angle = cal->theta_ref;
 280              		.loc 1 43 21 view .LVU74
 281 0140 C5ED027A 		vstr.32	s15, [r5, #8]
  44:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
 282              		.loc 1 44 6 is_stmt 1 view .LVU75
  44:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
 283              		.loc 1 44 35 is_stmt 0 view .LVU76
 284 0144 05F50243 		add	r3, r5, #33280
ARM GAS  /tmp/ccklse9U.s 			page 8


 285 0148 C3ED227A 		vstr.32	s15, [r3, #136]
  45:Core/Src/calibration.c ****     	return;
 286              		.loc 1 45 3 is_stmt 1 view .LVU77
 287 014c 05F50241 		add	r1, r5, #33280
 288 0150 2C31     		adds	r1, r1, #44
 289 0152 3046     		mov	r0, r6
 290 0154 FFF7FEFF 		bl	commutate
 291              	.LVL21:
  46:Core/Src/calibration.c ****     }
 292              		.loc 1 46 6 view .LVU78
 293 0158 C6E7     		b	.L1
 294              	.LVL22:
 295              	.L16:
  59:Core/Src/calibration.c **** 		printf("Swapping phase sign\r\n");
 296              		.loc 1 59 3 view .LVU79
  59:Core/Src/calibration.c **** 		printf("Swapping phase sign\r\n");
 297              		.loc 1 59 20 is_stmt 0 view .LVU80
 298 015a 0123     		movs	r3, #1
 299 015c 85F82030 		strb	r3, [r5, #32]
  60:Core/Src/calibration.c **** 	}
 300              		.loc 1 60 3 is_stmt 1 view .LVU81
 301 0160 0A48     		ldr	r0, .L21+36
 302 0162 FFF7FEFF 		bl	puts
 303              	.LVL23:
 304 0166 9AE7     		b	.L10
 305              	.L22:
 306              		.align	2
 307              	.L21:
 308 0168 00000000 		.word	__int_reg
 309 016c 17B7D137 		.word	936490775
 310 0170 BE6CD03F 		.word	1070623934
 311 0174 DB0FC940 		.word	1086918619
 312 0178 24000000 		.word	.LC1
 313 017c 54000000 		.word	.LC3
 314 0180 68000000 		.word	.LC4
 315 0184 00000000 		.word	__float_reg
 316 0188 00000000 		.word	.LC0
 317 018c 3C000000 		.word	.LC2
 318              		.cfi_endproc
 319              	.LFE238:
 321              		.section	.rodata.calibrate_encoder.str1.4,"aMS",%progbits,1
 322              		.align	2
 323              	.LC5:
 324 0000 53746172 		.ascii	"Starting offset cal and linearization\015\000"
 324      74696E67 
 324      206F6666 
 324      73657420 
 324      63616C20 
 325 0027 00       		.align	2
 326              	.LC6:
 327 0028 25642025 		.ascii	"%d %d %d %.3f\015\012\000"
 327      64202564 
 327      20252E33 
 327      660D0A00 
 328              		.align	2
 329              	.LC7:
 330 0038 25642020 		.ascii	"%d  %d\015\012\000"
ARM GAS  /tmp/ccklse9U.s 			page 9


 330      25640D0A 
 330      00
 331              		.section	.text.calibrate_encoder,"ax",%progbits
 332              		.align	1
 333              		.global	calibrate_encoder
 334              		.syntax unified
 335              		.thumb
 336              		.thumb_func
 337              		.fpu fpv4-sp-d16
 339              	calibrate_encoder:
 340              	.LVL24:
 341              	.LFB239:
  69:Core/Src/calibration.c **** 
  70:Core/Src/calibration.c **** void calibrate_encoder(EncoderStruct *encoder, ControllerStruct *controller, CalStruct * cal, int l
 342              		.loc 1 70 110 view -0
 343              		.cfi_startproc
 344              		@ args = 0, pretend = 0, frame = 0
 345              		@ frame_needed = 0, uses_anonymous_args = 0
 346              		.loc 1 70 110 is_stmt 0 view .LVU83
 347 0000 2DE9F041 		push	{r4, r5, r6, r7, r8, lr}
 348              	.LCFI6:
 349              		.cfi_def_cfa_offset 24
 350              		.cfi_offset 4, -24
 351              		.cfi_offset 5, -20
 352              		.cfi_offset 6, -16
 353              		.cfi_offset 7, -12
 354              		.cfi_offset 8, -8
 355              		.cfi_offset 14, -4
 356 0004 2DED028B 		vpush.64	{d8}
 357              	.LCFI7:
 358              		.cfi_def_cfa_offset 32
 359              		.cfi_offset 80, -32
 360              		.cfi_offset 81, -28
 361 0008 82B0     		sub	sp, sp, #8
 362              	.LCFI8:
 363              		.cfi_def_cfa_offset 40
 364 000a 0746     		mov	r7, r0
 365 000c 0E46     		mov	r6, r1
 366 000e 1446     		mov	r4, r2
 367 0010 1D46     		mov	r5, r3
  71:Core/Src/calibration.c **** 	/* Calibrates e-zero and encoder nonliearity */
  72:Core/Src/calibration.c **** 
  73:Core/Src/calibration.c **** 	if(!cal->started){
 368              		.loc 1 73 2 is_stmt 1 view .LVU84
 369              		.loc 1 73 9 is_stmt 0 view .LVU85
 370 0012 137C     		ldrb	r3, [r2, #16]	@ zero_extendqisi2
 371              	.LVL25:
 372              		.loc 1 73 4 view .LVU86
 373 0014 002B     		cmp	r3, #0
 374 0016 3ED0     		beq	.L58
 375              	.LVL26:
 376              	.L24:
  74:Core/Src/calibration.c **** 			printf("Starting offset cal and linearization\r\n");
  75:Core/Src/calibration.c **** 			cal->started = 1;
  76:Core/Src/calibration.c **** 			cal->start_count = loop_count;
  77:Core/Src/calibration.c **** 			cal->next_sample_time = T1;
  78:Core/Src/calibration.c **** 			cal->sample_count = 0;
ARM GAS  /tmp/ccklse9U.s 			page 10


  79:Core/Src/calibration.c **** 		}
  80:Core/Src/calibration.c **** 
  81:Core/Src/calibration.c **** 	cal->time = (float)(loop_count - cal->start_count)*DT;
 377              		.loc 1 81 2 is_stmt 1 view .LVU87
 378              		.loc 1 81 38 is_stmt 0 view .LVU88
 379 0018 E368     		ldr	r3, [r4, #12]
 380              		.loc 1 81 33 view .LVU89
 381 001a EB1A     		subs	r3, r5, r3
 382 001c 07EE903A 		vmov	s15, r3	@ int
 383              		.loc 1 81 14 view .LVU90
 384 0020 F8EEE77A 		vcvt.f32.s32	s15, s15
 385              		.loc 1 81 52 view .LVU91
 386 0024 9FEDDC7A 		vldr.32	s14, .L67
 387 0028 67EE877A 		vmul.f32	s15, s15, s14
 388              		.loc 1 81 12 view .LVU92
 389 002c C4ED057A 		vstr.32	s15, [r4, #20]
  82:Core/Src/calibration.c **** 
  83:Core/Src/calibration.c ****     if(cal->time < T1){
 390              		.loc 1 83 5 is_stmt 1 view .LVU93
 391              		.loc 1 83 7 is_stmt 0 view .LVU94
 392 0030 B7EE007A 		vmov.f32	s14, #1.0e+0
 393 0034 F4EEC77A 		vcmpe.f32	s15, s14
 394 0038 F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 395 003c 37D4     		bmi	.L59
  84:Core/Src/calibration.c ****         // Set voltage angle to zero, wait for rotor position to settle
  85:Core/Src/calibration.c ****         cal->theta_ref = 0;//W_CAL*cal->time;
  86:Core/Src/calibration.c ****         cal->cal_position.elec_angle = cal->theta_ref;
  87:Core/Src/calibration.c ****         controller->i_d_des = I_CAL;
  88:Core/Src/calibration.c ****         controller->i_q_des = 0.0f;
  89:Core/Src/calibration.c ****         commutate(controller, &cal->cal_position);
  90:Core/Src/calibration.c **** 
  91:Core/Src/calibration.c ****     	cal->theta_start = encoder->angle_multiturn[0];
  92:Core/Src/calibration.c ****     	cal->next_sample_time = cal->time;
  93:Core/Src/calibration.c ****     	return;
  94:Core/Src/calibration.c ****     }
  95:Core/Src/calibration.c ****     else if (cal->time < T1+2.0f*PI_F*PPAIRS/W_CAL){
 396              		.loc 1 95 10 is_stmt 1 view .LVU95
 397              		.loc 1 95 39 is_stmt 0 view .LVU96
 398 003e D74B     		ldr	r3, .L67+4
 399 0040 93ED0A7A 		vldr.32	s14, [r3, #40]
 400              		.loc 1 95 38 view .LVU97
 401 0044 9FEDD66A 		vldr.32	s12, .L67+8
 402 0048 27EE066A 		vmul.f32	s12, s14, s12
 403              		.loc 1 95 45 view .LVU98
 404 004c F2EE045A 		vmov.f32	s11, #1.0e+1
 405 0050 C6EE256A 		vdiv.f32	s13, s12, s11
 406              		.loc 1 95 28 view .LVU99
 407 0054 B7EE006A 		vmov.f32	s12, #1.0e+0
 408 0058 76EE866A 		vadd.f32	s13, s13, s12
 409              		.loc 1 95 13 view .LVU100
 410 005c F4EEE67A 		vcmpe.f32	s15, s13
 411 0060 F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 412 0064 3AD4     		bmi	.L60
  96:Core/Src/calibration.c ****     	// rotate voltage vector through one mechanical rotation in the positive direction
  97:Core/Src/calibration.c **** 		cal->theta_ref += W_CAL*DT;//(cal->time-T1);
  98:Core/Src/calibration.c **** 		cal->cal_position.elec_angle = cal->theta_ref;
  99:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
ARM GAS  /tmp/ccklse9U.s 			page 11


 100:Core/Src/calibration.c **** 
 101:Core/Src/calibration.c **** 		// sample SAMPLES_PER_PPAIR times per pole-pair
 102:Core/Src/calibration.c **** 		if(cal->time > cal->next_sample_time){
 103:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 104:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;//- encoder->raw;
 105:Core/Src/calibration.c **** 			cal->error_arr[cal->sample_count] = error + ENC_CPR*(error<0);
 106:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 107:Core/Src/calibration.c **** 			cal->next_sample_time += 2.0f*PI_F/(W_CAL*SAMPLES_PER_PPAIR);
 108:Core/Src/calibration.c **** 			if(cal->sample_count == PPAIRS*SAMPLES_PER_PPAIR-1){
 109:Core/Src/calibration.c **** 				return;
 110:Core/Src/calibration.c **** 			}
 111:Core/Src/calibration.c **** 			cal->sample_count++;
 112:Core/Src/calibration.c **** 
 113:Core/Src/calibration.c **** 		}
 114:Core/Src/calibration.c **** 		return;
 115:Core/Src/calibration.c ****     }
 116:Core/Src/calibration.c **** 	else if (cal->time < T1+4.0f*PI_F*PPAIRS/W_CAL){
 413              		.loc 1 116 7 is_stmt 1 view .LVU101
 414              		.loc 1 116 35 is_stmt 0 view .LVU102
 415 0066 DFEDCF6A 		vldr.32	s13, .L67+12
 416 006a 27EE267A 		vmul.f32	s14, s14, s13
 417              		.loc 1 116 42 view .LVU103
 418 006e B2EE046A 		vmov.f32	s12, #1.0e+1
 419 0072 C7EE066A 		vdiv.f32	s13, s14, s12
 420              		.loc 1 116 25 view .LVU104
 421 0076 B7EE007A 		vmov.f32	s14, #1.0e+0
 422 007a 36EE877A 		vadd.f32	s14, s13, s14
 423              		.loc 1 116 10 view .LVU105
 424 007e F4EEC77A 		vcmpe.f32	s15, s14
 425 0082 F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 426 0086 00F19180 		bmi	.L61
 117:Core/Src/calibration.c **** 		// rotate voltage vector through one mechanical rotation in the negative direction
 118:Core/Src/calibration.c **** 		cal->theta_ref -= W_CAL*DT;//(cal->time-T1);
 119:Core/Src/calibration.c **** 		controller->i_d_des = I_CAL;
 120:Core/Src/calibration.c **** 		controller->i_q_des = 0.0f;
 121:Core/Src/calibration.c **** 		cal->cal_position.elec_angle = cal->theta_ref;
 122:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
 123:Core/Src/calibration.c **** 
 124:Core/Src/calibration.c **** 		// sample SAMPLES_PER_PPAIR times per pole-pair
 125:Core/Src/calibration.c **** 		if((cal->time > cal->next_sample_time)&&(cal->sample_count>0)){
 126:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 127:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;// - encoder->raw;
 128:Core/Src/calibration.c **** 			error = error + ENC_CPR*(error<0);
 129:Core/Src/calibration.c **** 
 130:Core/Src/calibration.c **** 			cal->error_arr[cal->sample_count] = (cal->error_arr[cal->sample_count] + error)/2;
 131:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 132:Core/Src/calibration.c **** 			cal->sample_count--;
 133:Core/Src/calibration.c **** 			cal->next_sample_time += 2.0f*PI_F/(W_CAL*SAMPLES_PER_PPAIR);
 134:Core/Src/calibration.c **** 		}
 135:Core/Src/calibration.c **** 		return;
 136:Core/Src/calibration.c ****     }
 137:Core/Src/calibration.c **** 
 138:Core/Src/calibration.c ****     reset_foc(controller);
 427              		.loc 1 138 5 is_stmt 1 view .LVU106
 428 008a 3046     		mov	r0, r6
 429 008c FFF7FEFF 		bl	reset_foc
 430              	.LVL27:
ARM GAS  /tmp/ccklse9U.s 			page 12


 139:Core/Src/calibration.c **** 
 140:Core/Src/calibration.c ****     // Calculate average offset
 141:Core/Src/calibration.c ****     int ezero_mean = 0;
 431              		.loc 1 141 5 view .LVU107
 142:Core/Src/calibration.c **** 	for(int i = 0; i<((int)PPAIRS*SAMPLES_PER_PPAIR); i++){
 432              		.loc 1 142 2 view .LVU108
 433              	.LBB2:
 434              		.loc 1 142 6 view .LVU109
 435              		.loc 1 142 10 is_stmt 0 view .LVU110
 436 0090 0022     		movs	r2, #0
 437              	.LBE2:
 141:Core/Src/calibration.c **** 	for(int i = 0; i<((int)PPAIRS*SAMPLES_PER_PPAIR); i++){
 438              		.loc 1 141 9 view .LVU111
 439 0092 1346     		mov	r3, r2
 440              	.LBB3:
 441              		.loc 1 142 2 view .LVU112
 442 0094 F5E0     		b	.L36
 443              	.LVL28:
 444              	.L58:
 445              		.loc 1 142 2 view .LVU113
 446              	.LBE3:
  74:Core/Src/calibration.c **** 			cal->started = 1;
 447              		.loc 1 74 4 is_stmt 1 view .LVU114
 448 0096 C448     		ldr	r0, .L67+16
 449              	.LVL29:
  74:Core/Src/calibration.c **** 			cal->started = 1;
 450              		.loc 1 74 4 is_stmt 0 view .LVU115
 451 0098 FFF7FEFF 		bl	puts
 452              	.LVL30:
  75:Core/Src/calibration.c **** 			cal->start_count = loop_count;
 453              		.loc 1 75 4 is_stmt 1 view .LVU116
  75:Core/Src/calibration.c **** 			cal->start_count = loop_count;
 454              		.loc 1 75 17 is_stmt 0 view .LVU117
 455 009c 0123     		movs	r3, #1
 456 009e 2374     		strb	r3, [r4, #16]
  76:Core/Src/calibration.c **** 			cal->next_sample_time = T1;
 457              		.loc 1 76 4 is_stmt 1 view .LVU118
  76:Core/Src/calibration.c **** 			cal->next_sample_time = T1;
 458              		.loc 1 76 21 is_stmt 0 view .LVU119
 459 00a0 E560     		str	r5, [r4, #12]
  77:Core/Src/calibration.c **** 			cal->sample_count = 0;
 460              		.loc 1 77 4 is_stmt 1 view .LVU120
  77:Core/Src/calibration.c **** 			cal->sample_count = 0;
 461              		.loc 1 77 26 is_stmt 0 view .LVU121
 462 00a2 4FF07E53 		mov	r3, #1065353216
 463 00a6 A362     		str	r3, [r4, #40]	@ float
  78:Core/Src/calibration.c **** 		}
 464              		.loc 1 78 4 is_stmt 1 view .LVU122
  78:Core/Src/calibration.c **** 		}
 465              		.loc 1 78 22 is_stmt 0 view .LVU123
 466 00a8 0023     		movs	r3, #0
 467 00aa A384     		strh	r3, [r4, #36]	@ movhi
 468 00ac B4E7     		b	.L24
 469              	.L59:
  85:Core/Src/calibration.c ****         cal->cal_position.elec_angle = cal->theta_ref;
 470              		.loc 1 85 9 is_stmt 1 view .LVU124
  85:Core/Src/calibration.c ****         cal->cal_position.elec_angle = cal->theta_ref;
ARM GAS  /tmp/ccklse9U.s 			page 13


 471              		.loc 1 85 24 is_stmt 0 view .LVU125
 472 00ae 0023     		movs	r3, #0
 473 00b0 A360     		str	r3, [r4, #8]	@ float
  86:Core/Src/calibration.c ****         controller->i_d_des = I_CAL;
 474              		.loc 1 86 9 is_stmt 1 view .LVU126
  86:Core/Src/calibration.c ****         controller->i_d_des = I_CAL;
 475              		.loc 1 86 38 is_stmt 0 view .LVU127
 476 00b2 04F50242 		add	r2, r4, #33280
 477 00b6 C2F88830 		str	r3, [r2, #136]	@ float
  87:Core/Src/calibration.c ****         controller->i_q_des = 0.0f;
 478              		.loc 1 87 9 is_stmt 1 view .LVU128
  87:Core/Src/calibration.c ****         controller->i_q_des = 0.0f;
 479              		.loc 1 87 31 is_stmt 0 view .LVU129
 480 00ba B84A     		ldr	r2, .L67+4
 481 00bc 926C     		ldr	r2, [r2, #72]	@ float
  87:Core/Src/calibration.c ****         controller->i_q_des = 0.0f;
 482              		.loc 1 87 29 view .LVU130
 483 00be C6F8AC20 		str	r2, [r6, #172]	@ float
  88:Core/Src/calibration.c ****         commutate(controller, &cal->cal_position);
 484              		.loc 1 88 9 is_stmt 1 view .LVU131
  88:Core/Src/calibration.c ****         commutate(controller, &cal->cal_position);
 485              		.loc 1 88 29 is_stmt 0 view .LVU132
 486 00c2 C6F8B030 		str	r3, [r6, #176]	@ float
  89:Core/Src/calibration.c **** 
 487              		.loc 1 89 9 is_stmt 1 view .LVU133
 488 00c6 04F50241 		add	r1, r4, #33280
 489 00ca 2C31     		adds	r1, r1, #44
 490 00cc 3046     		mov	r0, r6
 491 00ce FFF7FEFF 		bl	commutate
 492              	.LVL31:
  91:Core/Src/calibration.c ****     	cal->next_sample_time = cal->time;
 493              		.loc 1 91 6 view .LVU134
  91:Core/Src/calibration.c ****     	cal->next_sample_time = cal->time;
 494              		.loc 1 91 49 is_stmt 0 view .LVU135
 495 00d2 FB68     		ldr	r3, [r7, #12]	@ float
  91:Core/Src/calibration.c ****     	cal->next_sample_time = cal->time;
 496              		.loc 1 91 23 view .LVU136
 497 00d4 A361     		str	r3, [r4, #24]	@ float
  92:Core/Src/calibration.c ****     	return;
 498              		.loc 1 92 6 is_stmt 1 view .LVU137
  92:Core/Src/calibration.c ****     	return;
 499              		.loc 1 92 33 is_stmt 0 view .LVU138
 500 00d6 6369     		ldr	r3, [r4, #20]	@ float
  92:Core/Src/calibration.c ****     	return;
 501              		.loc 1 92 28 view .LVU139
 502 00d8 A362     		str	r3, [r4, #40]	@ float
  93:Core/Src/calibration.c ****     }
 503              		.loc 1 93 6 is_stmt 1 view .LVU140
 504 00da 7CE1     		b	.L23
 505              	.L60:
  97:Core/Src/calibration.c **** 		cal->cal_position.elec_angle = cal->theta_ref;
 506              		.loc 1 97 3 view .LVU141
  97:Core/Src/calibration.c **** 		cal->cal_position.elec_angle = cal->theta_ref;
 507              		.loc 1 97 18 is_stmt 0 view .LVU142
 508 00dc D4ED027A 		vldr.32	s15, [r4, #8]
 509 00e0 9FEDB27A 		vldr.32	s14, .L67+20
 510 00e4 77EE877A 		vadd.f32	s15, s15, s14
ARM GAS  /tmp/ccklse9U.s 			page 14


 511 00e8 C4ED027A 		vstr.32	s15, [r4, #8]
  98:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
 512              		.loc 1 98 3 is_stmt 1 view .LVU143
  98:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
 513              		.loc 1 98 32 is_stmt 0 view .LVU144
 514 00ec 04F50243 		add	r3, r4, #33280
 515 00f0 C3ED227A 		vstr.32	s15, [r3, #136]
  99:Core/Src/calibration.c **** 
 516              		.loc 1 99 3 is_stmt 1 view .LVU145
 517 00f4 04F50241 		add	r1, r4, #33280
 518 00f8 2C31     		adds	r1, r1, #44
 519 00fa 3046     		mov	r0, r6
 520 00fc FFF7FEFF 		bl	commutate
 521              	.LVL32:
 102:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 522              		.loc 1 102 3 view .LVU146
 102:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 523              		.loc 1 102 9 is_stmt 0 view .LVU147
 524 0100 94ED057A 		vldr.32	s14, [r4, #20]
 102:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 525              		.loc 1 102 21 view .LVU148
 526 0104 D4ED0A7A 		vldr.32	s15, [r4, #40]
 102:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 527              		.loc 1 102 5 view .LVU149
 528 0108 B4EEE77A 		vcmpe.f32	s14, s15
 529 010c F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 530 0110 40F36181 		ble	.L23
 531              	.LBB4:
 103:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;//- encoder->raw;
 532              		.loc 1 103 4 is_stmt 1 view .LVU150
 103:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;//- encoder->raw;
 533              		.loc 1 103 23 is_stmt 0 view .LVU151
 534 0114 94ED026A 		vldr.32	s12, [r4, #8]
 103:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;//- encoder->raw;
 535              		.loc 1 103 35 view .LVU152
 536 0118 DFEDA56A 		vldr.32	s13, .L67+24
 537 011c 66EE266A 		vmul.f32	s13, s12, s13
 103:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;//- encoder->raw;
 538              		.loc 1 103 63 view .LVU153
 539 0120 DFF87882 		ldr	r8, .L67+4
 540 0124 98ED0A7A 		vldr.32	s14, [r8, #40]
 103:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;//- encoder->raw;
 541              		.loc 1 103 62 view .LVU154
 542 0128 DFED9D7A 		vldr.32	s15, .L67+8
 543 012c 27EE277A 		vmul.f32	s14, s14, s15
 103:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;//- encoder->raw;
 544              		.loc 1 103 51 view .LVU155
 545 0130 C6EE877A 		vdiv.f32	s15, s13, s14
 103:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;//- encoder->raw;
 546              		.loc 1 103 8 view .LVU156
 547 0134 FDEEE77A 		vcvt.s32.f32	s15, s15
 548 0138 17EE906A 		vmov	r6, s15	@ int
 549              	.LVL33:
 104:Core/Src/calibration.c **** 			cal->error_arr[cal->sample_count] = error + ENC_CPR*(error<0);
 550              		.loc 1 104 4 is_stmt 1 view .LVU157
 104:Core/Src/calibration.c **** 			cal->error_arr[cal->sample_count] = error + ENC_CPR*(error<0);
 551              		.loc 1 104 23 is_stmt 0 view .LVU158
ARM GAS  /tmp/ccklse9U.s 			page 15


 552 013c 7B6F     		ldr	r3, [r7, #116]
 104:Core/Src/calibration.c **** 			cal->error_arr[cal->sample_count] = error + ENC_CPR*(error<0);
 553              		.loc 1 104 8 view .LVU159
 554 013e 9B1B     		subs	r3, r3, r6
 555              	.LVL34:
 105:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 556              		.loc 1 105 4 is_stmt 1 view .LVU160
 105:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 557              		.loc 1 105 55 is_stmt 0 view .LVU161
 558 0140 DD13     		asrs	r5, r3, #15
 559              	.LVL35:
 105:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 560              		.loc 1 105 55 view .LVU162
 561 0142 05F48035 		and	r5, r5, #65536
 105:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 562              		.loc 1 105 22 view .LVU163
 563 0146 A78C     		ldrh	r7, [r4, #36]
 564              	.LVL36:
 105:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 565              		.loc 1 105 46 view .LVU164
 566 0148 1D44     		add	r5, r5, r3
 105:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 567              		.loc 1 105 38 view .LVU165
 568 014a 07F10A03 		add	r3, r7, #10
 569              	.LVL37:
 105:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 570              		.loc 1 105 38 view .LVU166
 571 014e 04EB8303 		add	r3, r4, r3, lsl #2
 572 0152 5D60     		str	r5, [r3, #4]
 573              	.LVL38:
 106:Core/Src/calibration.c **** 			cal->next_sample_time += 2.0f*PI_F/(W_CAL*SAMPLES_PER_PPAIR);
 574              		.loc 1 106 4 is_stmt 1 view .LVU167
 575 0154 16EE100A 		vmov	r0, s12
 576 0158 FFF7FEFF 		bl	__aeabi_f2d
 577              	.LVL39:
 578 015c CDE90001 		strd	r0, [sp]
 579 0160 2B46     		mov	r3, r5
 580 0162 3246     		mov	r2, r6
 581 0164 3946     		mov	r1, r7
 582 0166 9348     		ldr	r0, .L67+28
 583 0168 FFF7FEFF 		bl	printf
 584              	.LVL40:
 107:Core/Src/calibration.c **** 			if(cal->sample_count == PPAIRS*SAMPLES_PER_PPAIR-1){
 585              		.loc 1 107 4 view .LVU168
 107:Core/Src/calibration.c **** 			if(cal->sample_count == PPAIRS*SAMPLES_PER_PPAIR-1){
 586              		.loc 1 107 26 is_stmt 0 view .LVU169
 587 016c D4ED0A7A 		vldr.32	s15, [r4, #40]
 588 0170 9FED917A 		vldr.32	s14, .L67+32
 589 0174 77EE877A 		vadd.f32	s15, s15, s14
 590 0178 C4ED0A7A 		vstr.32	s15, [r4, #40]
 108:Core/Src/calibration.c **** 				return;
 591              		.loc 1 108 4 is_stmt 1 view .LVU170
 108:Core/Src/calibration.c **** 				return;
 592              		.loc 1 108 10 is_stmt 0 view .LVU171
 593 017c A38C     		ldrh	r3, [r4, #36]
 108:Core/Src/calibration.c **** 				return;
 594              		.loc 1 108 25 view .LVU172
ARM GAS  /tmp/ccklse9U.s 			page 16


 595 017e 07EE903A 		vmov	s15, r3	@ int
 596 0182 B8EEE77A 		vcvt.f32.s32	s14, s15
 108:Core/Src/calibration.c **** 				return;
 597              		.loc 1 108 28 view .LVU173
 598 0186 D8ED0A7A 		vldr.32	s15, [r8, #40]
 108:Core/Src/calibration.c **** 				return;
 599              		.loc 1 108 34 view .LVU174
 600 018a DFED8C6A 		vldr.32	s13, .L67+36
 601 018e 67EEA67A 		vmul.f32	s15, s15, s13
 108:Core/Src/calibration.c **** 				return;
 602              		.loc 1 108 52 view .LVU175
 603 0192 F7EE006A 		vmov.f32	s13, #1.0e+0
 604 0196 77EEE67A 		vsub.f32	s15, s15, s13
 108:Core/Src/calibration.c **** 				return;
 605              		.loc 1 108 6 view .LVU176
 606 019a B4EE677A 		vcmp.f32	s14, s15
 607 019e F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 608 01a2 00F01881 		beq	.L23
 111:Core/Src/calibration.c **** 
 609              		.loc 1 111 4 is_stmt 1 view .LVU177
 111:Core/Src/calibration.c **** 
 610              		.loc 1 111 21 is_stmt 0 view .LVU178
 611 01a6 0133     		adds	r3, r3, #1
 612 01a8 A384     		strh	r3, [r4, #36]	@ movhi
 613              	.LBE4:
 114:Core/Src/calibration.c ****     }
 614              		.loc 1 114 3 is_stmt 1 view .LVU179
 615 01aa 14E1     		b	.L23
 616              	.LVL41:
 617              	.L61:
 118:Core/Src/calibration.c **** 		controller->i_d_des = I_CAL;
 618              		.loc 1 118 3 view .LVU180
 118:Core/Src/calibration.c **** 		controller->i_d_des = I_CAL;
 619              		.loc 1 118 18 is_stmt 0 view .LVU181
 620 01ac D4ED027A 		vldr.32	s15, [r4, #8]
 621 01b0 9FED7E7A 		vldr.32	s14, .L67+20
 622 01b4 77EEC77A 		vsub.f32	s15, s15, s14
 623 01b8 C4ED027A 		vstr.32	s15, [r4, #8]
 119:Core/Src/calibration.c **** 		controller->i_q_des = 0.0f;
 624              		.loc 1 119 3 is_stmt 1 view .LVU182
 119:Core/Src/calibration.c **** 		controller->i_q_des = 0.0f;
 625              		.loc 1 119 25 is_stmt 0 view .LVU183
 626 01bc 774B     		ldr	r3, .L67+4
 627 01be 9B6C     		ldr	r3, [r3, #72]	@ float
 119:Core/Src/calibration.c **** 		controller->i_q_des = 0.0f;
 628              		.loc 1 119 23 view .LVU184
 629 01c0 C6F8AC30 		str	r3, [r6, #172]	@ float
 120:Core/Src/calibration.c **** 		cal->cal_position.elec_angle = cal->theta_ref;
 630              		.loc 1 120 3 is_stmt 1 view .LVU185
 120:Core/Src/calibration.c **** 		cal->cal_position.elec_angle = cal->theta_ref;
 631              		.loc 1 120 23 is_stmt 0 view .LVU186
 632 01c4 0023     		movs	r3, #0
 633 01c6 C6F8B030 		str	r3, [r6, #176]	@ float
 121:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
 634              		.loc 1 121 3 is_stmt 1 view .LVU187
 121:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
 635              		.loc 1 121 37 is_stmt 0 view .LVU188
ARM GAS  /tmp/ccklse9U.s 			page 17


 636 01ca A268     		ldr	r2, [r4, #8]	@ float
 121:Core/Src/calibration.c **** 		commutate(controller, &cal->cal_position);
 637              		.loc 1 121 32 view .LVU189
 638 01cc 04F50243 		add	r3, r4, #33280
 639 01d0 C3F88820 		str	r2, [r3, #136]	@ float
 122:Core/Src/calibration.c **** 
 640              		.loc 1 122 3 is_stmt 1 view .LVU190
 641 01d4 04F50241 		add	r1, r4, #33280
 642 01d8 2C31     		adds	r1, r1, #44
 643 01da 3046     		mov	r0, r6
 644 01dc FFF7FEFF 		bl	commutate
 645              	.LVL42:
 125:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 646              		.loc 1 125 3 view .LVU191
 125:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 647              		.loc 1 125 10 is_stmt 0 view .LVU192
 648 01e0 94ED057A 		vldr.32	s14, [r4, #20]
 125:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 649              		.loc 1 125 22 view .LVU193
 650 01e4 D4ED0A7A 		vldr.32	s15, [r4, #40]
 125:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 651              		.loc 1 125 5 view .LVU194
 652 01e8 B4EEE77A 		vcmpe.f32	s14, s15
 653 01ec F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 654 01f0 40F3F180 		ble	.L23
 125:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 655              		.loc 1 125 47 discriminator 1 view .LVU195
 656 01f4 A68C     		ldrh	r6, [r4, #36]
 657              	.LVL43:
 125:Core/Src/calibration.c **** 			int count_ref = cal->theta_ref * (float)ENC_CPR/(2.0f*PI_F*PPAIRS);
 658              		.loc 1 125 41 discriminator 1 view .LVU196
 659 01f6 002E     		cmp	r6, #0
 660 01f8 00F0ED80 		beq	.L23
 661              	.LBB5:
 126:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;// - encoder->raw;
 662              		.loc 1 126 4 is_stmt 1 view .LVU197
 126:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;// - encoder->raw;
 663              		.loc 1 126 23 is_stmt 0 view .LVU198
 664 01fc 94ED026A 		vldr.32	s12, [r4, #8]
 126:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;// - encoder->raw;
 665              		.loc 1 126 35 view .LVU199
 666 0200 DFED6B6A 		vldr.32	s13, .L67+24
 667 0204 66EE266A 		vmul.f32	s13, s12, s13
 126:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;// - encoder->raw;
 668              		.loc 1 126 63 view .LVU200
 669 0208 644B     		ldr	r3, .L67+4
 670 020a 93ED0A7A 		vldr.32	s14, [r3, #40]
 126:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;// - encoder->raw;
 671              		.loc 1 126 62 view .LVU201
 672 020e DFED647A 		vldr.32	s15, .L67+8
 673 0212 27EE277A 		vmul.f32	s14, s14, s15
 126:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;// - encoder->raw;
 674              		.loc 1 126 51 view .LVU202
 675 0216 C6EE877A 		vdiv.f32	s15, s13, s14
 126:Core/Src/calibration.c **** 			int error = encoder->raw - count_ref;// - encoder->raw;
 676              		.loc 1 126 8 view .LVU203
 677 021a FDEEE77A 		vcvt.s32.f32	s15, s15
ARM GAS  /tmp/ccklse9U.s 			page 18


 678 021e 17EE908A 		vmov	r8, s15	@ int
 679              	.LVL44:
 127:Core/Src/calibration.c **** 			error = error + ENC_CPR*(error<0);
 680              		.loc 1 127 4 is_stmt 1 view .LVU204
 127:Core/Src/calibration.c **** 			error = error + ENC_CPR*(error<0);
 681              		.loc 1 127 23 is_stmt 0 view .LVU205
 682 0222 7D6F     		ldr	r5, [r7, #116]
 683              	.LVL45:
 127:Core/Src/calibration.c **** 			error = error + ENC_CPR*(error<0);
 684              		.loc 1 127 8 view .LVU206
 685 0224 A5EB0805 		sub	r5, r5, r8
 686              	.LVL46:
 128:Core/Src/calibration.c **** 
 687              		.loc 1 128 4 is_stmt 1 view .LVU207
 128:Core/Src/calibration.c **** 
 688              		.loc 1 128 27 is_stmt 0 view .LVU208
 689 0228 EB13     		asrs	r3, r5, #15
 690 022a 03F48033 		and	r3, r3, #65536
 128:Core/Src/calibration.c **** 
 691              		.loc 1 128 10 view .LVU209
 692 022e 2B44     		add	r3, r3, r5
 693              	.LVL47:
 130:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 694              		.loc 1 130 4 is_stmt 1 view .LVU210
 130:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 695              		.loc 1 130 55 is_stmt 0 view .LVU211
 696 0230 06F10A02 		add	r2, r6, #10
 697 0234 04EB8202 		add	r2, r4, r2, lsl #2
 698 0238 5568     		ldr	r5, [r2, #4]
 130:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 699              		.loc 1 130 75 view .LVU212
 700 023a 1D44     		add	r5, r5, r3
 130:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 701              		.loc 1 130 83 view .LVU213
 702 023c 05EBD575 		add	r5, r5, r5, lsr #31
 703 0240 6D10     		asrs	r5, r5, #1
 130:Core/Src/calibration.c **** 			printf("%d %d %d %.3f\r\n", cal->sample_count, count_ref, cal->error_arr[cal->sample_count], cal
 704              		.loc 1 130 38 view .LVU214
 705 0242 5560     		str	r5, [r2, #4]
 131:Core/Src/calibration.c **** 			cal->sample_count--;
 706              		.loc 1 131 4 is_stmt 1 view .LVU215
 707 0244 16EE100A 		vmov	r0, s12
 708 0248 FFF7FEFF 		bl	__aeabi_f2d
 709              	.LVL48:
 131:Core/Src/calibration.c **** 			cal->sample_count--;
 710              		.loc 1 131 4 is_stmt 0 view .LVU216
 711 024c CDE90001 		strd	r0, [sp]
 712 0250 2B46     		mov	r3, r5
 713 0252 4246     		mov	r2, r8
 714 0254 3146     		mov	r1, r6
 715 0256 5748     		ldr	r0, .L67+28
 716 0258 FFF7FEFF 		bl	printf
 717              	.LVL49:
 132:Core/Src/calibration.c **** 			cal->next_sample_time += 2.0f*PI_F/(W_CAL*SAMPLES_PER_PPAIR);
 718              		.loc 1 132 4 is_stmt 1 view .LVU217
 132:Core/Src/calibration.c **** 			cal->next_sample_time += 2.0f*PI_F/(W_CAL*SAMPLES_PER_PPAIR);
 719              		.loc 1 132 7 is_stmt 0 view .LVU218
ARM GAS  /tmp/ccklse9U.s 			page 19


 720 025c A38C     		ldrh	r3, [r4, #36]
 132:Core/Src/calibration.c **** 			cal->next_sample_time += 2.0f*PI_F/(W_CAL*SAMPLES_PER_PPAIR);
 721              		.loc 1 132 21 view .LVU219
 722 025e 013B     		subs	r3, r3, #1
 723 0260 A384     		strh	r3, [r4, #36]	@ movhi
 133:Core/Src/calibration.c **** 		}
 724              		.loc 1 133 4 is_stmt 1 view .LVU220
 133:Core/Src/calibration.c **** 		}
 725              		.loc 1 133 26 is_stmt 0 view .LVU221
 726 0262 D4ED0A7A 		vldr.32	s15, [r4, #40]
 727 0266 9FED547A 		vldr.32	s14, .L67+32
 728 026a 77EE877A 		vadd.f32	s15, s15, s14
 729 026e C4ED0A7A 		vstr.32	s15, [r4, #40]
 730              	.LBE5:
 135:Core/Src/calibration.c ****     }
 731              		.loc 1 135 3 is_stmt 1 view .LVU222
 732 0272 B0E0     		b	.L23
 733              	.LVL50:
 734              	.L37:
 735              	.LBB6:
 143:Core/Src/calibration.c **** 		ezero_mean += cal->error_arr[i];
 736              		.loc 1 143 3 discriminator 3 view .LVU223
 737              		.loc 1 143 31 is_stmt 0 discriminator 3 view .LVU224
 738 0274 02F10A01 		add	r1, r2, #10
 739 0278 04EB8101 		add	r1, r4, r1, lsl #2
 740 027c 4968     		ldr	r1, [r1, #4]
 741              		.loc 1 143 14 discriminator 3 view .LVU225
 742 027e 0B44     		add	r3, r3, r1
 743              	.LVL51:
 142:Core/Src/calibration.c **** 		ezero_mean += cal->error_arr[i];
 744              		.loc 1 142 52 is_stmt 1 discriminator 3 view .LVU226
 142:Core/Src/calibration.c **** 		ezero_mean += cal->error_arr[i];
 745              		.loc 1 142 53 is_stmt 0 discriminator 3 view .LVU227
 746 0280 0132     		adds	r2, r2, #1
 747              	.LVL52:
 748              	.L36:
 142:Core/Src/calibration.c **** 		ezero_mean += cal->error_arr[i];
 749              		.loc 1 142 17 is_stmt 1 discriminator 1 view .LVU228
 142:Core/Src/calibration.c **** 		ezero_mean += cal->error_arr[i];
 750              		.loc 1 142 25 is_stmt 0 discriminator 1 view .LVU229
 751 0282 4649     		ldr	r1, .L67+4
 752 0284 D1ED0A7A 		vldr.32	s15, [r1, #40]
 142:Core/Src/calibration.c **** 		ezero_mean += cal->error_arr[i];
 753              		.loc 1 142 20 discriminator 1 view .LVU230
 754 0288 BDEEE77A 		vcvt.s32.f32	s14, s15
 755 028c 17EE101A 		vmov	r1, s14	@ int
 142:Core/Src/calibration.c **** 		ezero_mean += cal->error_arr[i];
 756              		.loc 1 142 2 discriminator 1 view .LVU231
 757 0290 B2EBC11F 		cmp	r2, r1, lsl #7
 758 0294 EEDB     		blt	.L37
 759              	.LBE6:
 144:Core/Src/calibration.c **** 	}
 145:Core/Src/calibration.c **** 	cal->ezero = ezero_mean/(SAMPLES_PER_PPAIR*PPAIRS);
 760              		.loc 1 145 2 is_stmt 1 view .LVU232
 761              		.loc 1 145 44 is_stmt 0 view .LVU233
 762 0296 9FED497A 		vldr.32	s14, .L67+36
 763 029a 27EE877A 		vmul.f32	s14, s15, s14
ARM GAS  /tmp/ccklse9U.s 			page 20


 764              		.loc 1 145 25 view .LVU234
 765 029e 07EE903A 		vmov	s15, r3	@ int
 766 02a2 F8EEE77A 		vcvt.f32.s32	s15, s15
 767 02a6 C7EE876A 		vdiv.f32	s13, s15, s14
 768              		.loc 1 145 13 view .LVU235
 769 02aa FDEEE66A 		vcvt.s32.f32	s13, s13
 770 02ae C4ED076A 		vstr.32	s13, [r4, #28]	@ int
 146:Core/Src/calibration.c **** 
 147:Core/Src/calibration.c **** 	// Moving average to filter out cogging ripple
 148:Core/Src/calibration.c **** 
 149:Core/Src/calibration.c **** 	int window = SAMPLES_PER_PPAIR;
 771              		.loc 1 149 2 is_stmt 1 view .LVU236
 772              	.LVL53:
 150:Core/Src/calibration.c **** 	int lut_offset = (ENC_CPR-cal->error_arr[0])*N_LUT/ENC_CPR;
 773              		.loc 1 150 2 view .LVU237
 774              		.loc 1 150 42 is_stmt 0 view .LVU238
 775 02b2 E56A     		ldr	r5, [r4, #44]
 776              	.LVL54:
 777              		.loc 1 150 6 view .LVU239
 778 02b4 D5F58035 		rsbs	r5, r5, #65536
 779 02b8 03D4     		bmi	.L62
 780              	.L38:
 781 02ba 6D12     		asrs	r5, r5, #9
 782              	.LVL55:
 151:Core/Src/calibration.c **** 	for(int i = 0; i<N_LUT; i++){
 783              		.loc 1 151 2 is_stmt 1 view .LVU240
 784              	.LBB7:
 785              		.loc 1 151 6 view .LVU241
 786              		.loc 1 151 10 is_stmt 0 view .LVU242
 787 02bc 9FED408A 		vldr.32	s16, .L67+40	@ int
 788              		.loc 1 151 2 view .LVU243
 789 02c0 5FE0     		b	.L39
 790              	.LVL56:
 791              	.L62:
 792              		.loc 1 151 2 view .LVU244
 793              	.LBE7:
 150:Core/Src/calibration.c **** 	int lut_offset = (ENC_CPR-cal->error_arr[0])*N_LUT/ENC_CPR;
 794              		.loc 1 150 6 view .LVU245
 795 02c2 05F2FF15 		addw	r5, r5, #511
 796 02c6 F8E7     		b	.L38
 797              	.LVL57:
 798              	.L64:
 799              	.LBB14:
 800              	.LBB8:
 801              	.LBB9:
 802              	.LBB10:
 152:Core/Src/calibration.c **** 			int moving_avg = 0;
 153:Core/Src/calibration.c **** 			for(int j = (-window)/2; j<(window)/2; j++){
 154:Core/Src/calibration.c **** 				int index = i*PPAIRS*SAMPLES_PER_PPAIR/N_LUT + j;
 155:Core/Src/calibration.c **** 				if(index<0){index += (SAMPLES_PER_PPAIR*PPAIRS);}
 803              		.loc 1 155 17 is_stmt 1 discriminator 1 view .LVU246
 804              		.loc 1 155 44 is_stmt 0 discriminator 1 view .LVU247
 805 02c8 9FED3C7A 		vldr.32	s14, .L67+36
 806 02cc 66EE876A 		vmul.f32	s13, s13, s14
 807              		.loc 1 155 23 discriminator 1 view .LVU248
 808 02d0 F8EEE77A 		vcvt.f32.s32	s15, s15
 809 02d4 77EEA67A 		vadd.f32	s15, s15, s13
ARM GAS  /tmp/ccklse9U.s 			page 21


 810 02d8 FDEEE77A 		vcvt.s32.f32	s15, s15
 811              	.LVL58:
 812              	.L41:
 156:Core/Src/calibration.c **** 				else if(index>(SAMPLES_PER_PPAIR*PPAIRS-1)){index -= (SAMPLES_PER_PPAIR*PPAIRS);}
 157:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 813              		.loc 1 157 5 is_stmt 1 discriminator 2 view .LVU249
 814              		.loc 1 157 33 is_stmt 0 discriminator 2 view .LVU250
 815 02dc 17EE903A 		vmov	r3, s15	@ int
 816 02e0 0A33     		adds	r3, r3, #10
 817 02e2 04EB8303 		add	r3, r4, r3, lsl #2
 818 02e6 5B68     		ldr	r3, [r3, #4]
 819              		.loc 1 157 16 discriminator 2 view .LVU251
 820 02e8 1944     		add	r1, r1, r3
 821              	.LVL59:
 822              		.loc 1 157 16 discriminator 2 view .LVU252
 823              	.LBE10:
 153:Core/Src/calibration.c **** 				int index = i*PPAIRS*SAMPLES_PER_PPAIR/N_LUT + j;
 824              		.loc 1 153 43 is_stmt 1 discriminator 2 view .LVU253
 153:Core/Src/calibration.c **** 				int index = i*PPAIRS*SAMPLES_PER_PPAIR/N_LUT + j;
 825              		.loc 1 153 44 is_stmt 0 discriminator 2 view .LVU254
 826 02ea 0132     		adds	r2, r2, #1
 827              	.LVL60:
 828              	.L46:
 153:Core/Src/calibration.c **** 				int index = i*PPAIRS*SAMPLES_PER_PPAIR/N_LUT + j;
 829              		.loc 1 153 29 is_stmt 1 discriminator 1 view .LVU255
 153:Core/Src/calibration.c **** 				int index = i*PPAIRS*SAMPLES_PER_PPAIR/N_LUT + j;
 830              		.loc 1 153 4 is_stmt 0 discriminator 1 view .LVU256
 831 02ec 3F2A     		cmp	r2, #63
 832 02ee 2EDC     		bgt	.L63
 833              	.LBB11:
 154:Core/Src/calibration.c **** 				if(index<0){index += (SAMPLES_PER_PPAIR*PPAIRS);}
 834              		.loc 1 154 5 is_stmt 1 view .LVU257
 154:Core/Src/calibration.c **** 				if(index<0){index += (SAMPLES_PER_PPAIR*PPAIRS);}
 835              		.loc 1 154 19 is_stmt 0 view .LVU258
 836 02f0 2A4B     		ldr	r3, .L67+4
 837 02f2 D3ED0A6A 		vldr.32	s13, [r3, #40]
 154:Core/Src/calibration.c **** 				if(index<0){index += (SAMPLES_PER_PPAIR*PPAIRS);}
 838              		.loc 1 154 18 view .LVU259
 839 02f6 F8EEC87A 		vcvt.f32.s32	s15, s16
 840 02fa 67EEA67A 		vmul.f32	s15, s15, s13
 154:Core/Src/calibration.c **** 				if(index<0){index += (SAMPLES_PER_PPAIR*PPAIRS);}
 841              		.loc 1 154 25 view .LVU260
 842 02fe 9FED2F7A 		vldr.32	s14, .L67+36
 843 0302 67EE877A 		vmul.f32	s15, s15, s14
 154:Core/Src/calibration.c **** 				if(index<0){index += (SAMPLES_PER_PPAIR*PPAIRS);}
 844              		.loc 1 154 43 view .LVU261
 845 0306 9FED2F7A 		vldr.32	s14, .L67+44
 846 030a 27EE877A 		vmul.f32	s14, s15, s14
 154:Core/Src/calibration.c **** 				if(index<0){index += (SAMPLES_PER_PPAIR*PPAIRS);}
 847              		.loc 1 154 50 view .LVU262
 848 030e 07EE902A 		vmov	s15, r2	@ int
 849 0312 F8EEE77A 		vcvt.f32.s32	s15, s15
 850 0316 77EE877A 		vadd.f32	s15, s15, s14
 154:Core/Src/calibration.c **** 				if(index<0){index += (SAMPLES_PER_PPAIR*PPAIRS);}
 851              		.loc 1 154 9 view .LVU263
 852 031a FDEEE77A 		vcvt.s32.f32	s15, s15
 853              	.LVL61:
ARM GAS  /tmp/ccklse9U.s 			page 22


 155:Core/Src/calibration.c **** 				else if(index>(SAMPLES_PER_PPAIR*PPAIRS-1)){index -= (SAMPLES_PER_PPAIR*PPAIRS);}
 854              		.loc 1 155 5 is_stmt 1 view .LVU264
 155:Core/Src/calibration.c **** 				else if(index>(SAMPLES_PER_PPAIR*PPAIRS-1)){index -= (SAMPLES_PER_PPAIR*PPAIRS);}
 855              		.loc 1 155 7 is_stmt 0 view .LVU265
 856 031e 17EE903A 		vmov	r3, s15	@ int
 857 0322 002B     		cmp	r3, #0
 858 0324 D0DB     		blt	.L64
 156:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 859              		.loc 1 156 10 is_stmt 1 view .LVU266
 156:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 860              		.loc 1 156 18 is_stmt 0 view .LVU267
 861 0326 B8EEE76A 		vcvt.f32.s32	s12, s15
 156:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 862              		.loc 1 156 37 view .LVU268
 863 032a 9FED247A 		vldr.32	s14, .L67+36
 864 032e 66EE876A 		vmul.f32	s13, s13, s14
 156:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 865              		.loc 1 156 44 view .LVU269
 866 0332 B7EE007A 		vmov.f32	s14, #1.0e+0
 867 0336 36EEC77A 		vsub.f32	s14, s13, s14
 156:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 868              		.loc 1 156 12 view .LVU270
 869 033a B4EEC76A 		vcmpe.f32	s12, s14
 870 033e F1EE10FA 		vmrs	APSR_nzcv, FPSCR
 871 0342 CBDD     		ble	.L41
 156:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 872              		.loc 1 156 49 is_stmt 1 discriminator 1 view .LVU271
 156:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 873              		.loc 1 156 55 is_stmt 0 discriminator 1 view .LVU272
 874 0344 76EE666A 		vsub.f32	s13, s12, s13
 875 0348 FDEEE67A 		vcvt.s32.f32	s15, s13
 876              	.LVL62:
 156:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 877              		.loc 1 156 55 discriminator 1 view .LVU273
 878 034c C6E7     		b	.L41
 879              	.LVL63:
 880              	.L63:
 156:Core/Src/calibration.c **** 				moving_avg += cal->error_arr[index];
 881              		.loc 1 156 55 discriminator 1 view .LVU274
 882              	.LBE11:
 883              	.LBE9:
 158:Core/Src/calibration.c **** 			}
 159:Core/Src/calibration.c **** 			moving_avg = moving_avg/window;
 884              		.loc 1 159 4 is_stmt 1 view .LVU275
 885              		.loc 1 159 15 is_stmt 0 view .LVU276
 886 034e 0B46     		mov	r3, r1
 887 0350 0029     		cmp	r1, #0
 888 0352 1EDB     		blt	.L65
 889              	.L44:
 890 0354 DB11     		asrs	r3, r3, #7
 891              	.LVL64:
 160:Core/Src/calibration.c **** 			int lut_index = lut_offset + i;
 892              		.loc 1 160 4 is_stmt 1 view .LVU277
 893              		.loc 1 160 8 is_stmt 0 view .LVU278
 894 0356 18EE102A 		vmov	r2, s16	@ int
 895              	.LVL65:
 896              		.loc 1 160 8 view .LVU279
ARM GAS  /tmp/ccklse9U.s 			page 23


 897 035a 5119     		adds	r1, r2, r5
 898              	.LVL66:
 161:Core/Src/calibration.c **** 			if(lut_index>(N_LUT-1)){lut_index -= N_LUT;}
 899              		.loc 1 161 4 is_stmt 1 view .LVU280
 900              		.loc 1 161 6 is_stmt 0 view .LVU281
 901 035c 7F29     		cmp	r1, #127
 902 035e 00DD     		ble	.L45
 903              	.LVL67:
 904              		.loc 1 161 28 is_stmt 1 discriminator 1 view .LVU282
 905              		.loc 1 161 38 is_stmt 0 discriminator 1 view .LVU283
 906 0360 8039     		subs	r1, r1, #128
 907              	.LVL68:
 908              	.L45:
 162:Core/Src/calibration.c **** 			cal->lut_arr[lut_index] = moving_avg - cal->ezero;
 909              		.loc 1 162 4 is_stmt 1 discriminator 2 view .LVU284
 910              		.loc 1 162 46 is_stmt 0 discriminator 2 view .LVU285
 911 0362 E269     		ldr	r2, [r4, #28]
 912              	.LVL69:
 913              		.loc 1 162 41 discriminator 2 view .LVU286
 914 0364 9A1A     		subs	r2, r3, r2
 915              		.loc 1 162 28 discriminator 2 view .LVU287
 916 0366 01F50053 		add	r3, r1, #8192
 917              	.LVL70:
 918              		.loc 1 162 28 discriminator 2 view .LVU288
 919 036a 0A33     		adds	r3, r3, #10
 920 036c 04EB8303 		add	r3, r4, r3, lsl #2
 921 0370 5A60     		str	r2, [r3, #4]
 163:Core/Src/calibration.c **** 			printf("%d  %d\r\n", lut_index, moving_avg - cal->ezero);
 922              		.loc 1 163 4 is_stmt 1 discriminator 2 view .LVU289
 923 0372 1548     		ldr	r0, .L67+48
 924 0374 FFF7FEFF 		bl	printf
 925              	.LVL71:
 926              		.loc 1 163 4 is_stmt 0 discriminator 2 view .LVU290
 927              	.LBE8:
 151:Core/Src/calibration.c **** 			int moving_avg = 0;
 928              		.loc 1 151 26 is_stmt 1 discriminator 2 view .LVU291
 151:Core/Src/calibration.c **** 			int moving_avg = 0;
 929              		.loc 1 151 27 is_stmt 0 discriminator 2 view .LVU292
 930 0378 18EE103A 		vmov	r3, s16	@ int
 931 037c 0133     		adds	r3, r3, #1
 932 037e 08EE103A 		vmov	s16, r3	@ int
 933              	.LVL72:
 934              	.L39:
 151:Core/Src/calibration.c **** 			int moving_avg = 0;
 935              		.loc 1 151 17 is_stmt 1 discriminator 1 view .LVU293
 151:Core/Src/calibration.c **** 			int moving_avg = 0;
 936              		.loc 1 151 2 is_stmt 0 discriminator 1 view .LVU294
 937 0382 18EE103A 		vmov	r3, s16	@ int
 938 0386 7F2B     		cmp	r3, #127
 939 0388 20DC     		bgt	.L66
 940              	.LBB13:
 941              	.LBB12:
 153:Core/Src/calibration.c **** 				int index = i*PPAIRS*SAMPLES_PER_PPAIR/N_LUT + j;
 942              		.loc 1 153 12 view .LVU295
 943 038a 6FF03F02 		mvn	r2, #63
 944              	.LBE12:
 152:Core/Src/calibration.c **** 			for(int j = (-window)/2; j<(window)/2; j++){
ARM GAS  /tmp/ccklse9U.s 			page 24


 945              		.loc 1 152 8 view .LVU296
 946 038e 0021     		movs	r1, #0
 947 0390 ACE7     		b	.L46
 948              	.LVL73:
 949              	.L65:
 159:Core/Src/calibration.c **** 			int lut_index = lut_offset + i;
 950              		.loc 1 159 15 view .LVU297
 951 0392 01F17F03 		add	r3, r1, #127
 952 0396 DDE7     		b	.L44
 953              	.L68:
 954              		.align	2
 955              	.L67:
 956 0398 17B7D137 		.word	936490775
 957 039c 00000000 		.word	__float_reg
 958 03a0 DB0FC940 		.word	1086918619
 959 03a4 DB0F4941 		.word	1095307227
 960 03a8 00000000 		.word	.LC5
 961 03ac 6E128339 		.word	964891246
 962 03b0 00008047 		.word	1199570944
 963 03b4 28000000 		.word	.LC6
 964 03b8 7CD9A03B 		.word	1000397180
 965 03bc 00000043 		.word	1124073472
 966 03c0 00000000 		.word	0
 967 03c4 0000003C 		.word	1006632960
 968 03c8 38000000 		.word	.LC7
 969              	.LVL74:
 970              	.L66:
 159:Core/Src/calibration.c **** 			int lut_index = lut_offset + i;
 971              		.loc 1 159 15 view .LVU298
 972              	.LBE13:
 973              	.LBE14:
 164:Core/Src/calibration.c **** 
 165:Core/Src/calibration.c **** 		}
 166:Core/Src/calibration.c **** 
 167:Core/Src/calibration.c **** 	cal->started = 0;
 974              		.loc 1 167 2 is_stmt 1 view .LVU299
 975              		.loc 1 167 15 is_stmt 0 view .LVU300
 976 03cc 0023     		movs	r3, #0
 977              	.LVL75:
 978              		.loc 1 167 15 view .LVU301
 979 03ce 2374     		strb	r3, [r4, #16]
 168:Core/Src/calibration.c **** 	cal->done_cal = 1;
 980              		.loc 1 168 2 is_stmt 1 view .LVU302
 981              		.loc 1 168 16 is_stmt 0 view .LVU303
 982 03d0 0123     		movs	r3, #1
 983 03d2 84F82230 		strb	r3, [r4, #34]
 984              	.LVL76:
 985              	.L23:
 169:Core/Src/calibration.c **** }
 986              		.loc 1 169 1 view .LVU304
 987 03d6 02B0     		add	sp, sp, #8
 988              	.LCFI9:
 989              		.cfi_def_cfa_offset 32
 990              		@ sp needed
 991 03d8 BDEC028B 		vldm	sp!, {d8}
 992              	.LCFI10:
 993              		.cfi_restore 80
ARM GAS  /tmp/ccklse9U.s 			page 25


 994              		.cfi_restore 81
 995              		.cfi_def_cfa_offset 24
 996 03dc BDE8F081 		pop	{r4, r5, r6, r7, r8, pc}
 997              		.loc 1 169 1 view .LVU305
 998              		.cfi_endproc
 999              	.LFE239:
 1001              		.section	.text.measure_lr,"ax",%progbits
 1002              		.align	1
 1003              		.global	measure_lr
 1004              		.syntax unified
 1005              		.thumb
 1006              		.thumb_func
 1007              		.fpu fpv4-sp-d16
 1009              	measure_lr:
 1010              	.LVL77:
 1011              	.LFB240:
 170:Core/Src/calibration.c **** 
 171:Core/Src/calibration.c **** void measure_lr(EncoderStruct *encoder, ControllerStruct *controller, CalStruct * cal, int loop_cou
 1012              		.loc 1 171 103 is_stmt 1 view -0
 1013              		.cfi_startproc
 1014              		@ args = 0, pretend = 0, frame = 0
 1015              		@ frame_needed = 0, uses_anonymous_args = 0
 1016              		@ link register save eliminated.
 172:Core/Src/calibration.c **** 
 173:Core/Src/calibration.c **** }
 1017              		.loc 1 173 1 view .LVU307
 1018 0000 7047     		bx	lr
 1019              		.cfi_endproc
 1020              	.LFE240:
 1022              		.text
 1023              	.Letext0:
 1024              		.file 2 "/usr/lib/gcc/arm-none-eabi/9.2.1/include/stdint.h"
 1025              		.file 3 "Drivers/CMSIS/Include/core_cm4.h"
 1026              		.file 4 "Drivers/CMSIS/Device/ST/STM32F4xx/Include/system_stm32f4xx.h"
 1027              		.file 5 "Drivers/CMSIS/Device/ST/STM32F4xx/Include/stm32f446xx.h"
 1028              		.file 6 "Drivers/STM32F4xx_HAL_Driver/Inc/stm32f4xx_hal_def.h"
 1029              		.file 7 "Drivers/STM32F4xx_HAL_Driver/Inc/stm32f4xx_hal_dma.h"
 1030              		.file 8 "Drivers/STM32F4xx_HAL_Driver/Inc/stm32f4xx_hal_spi.h"
 1031              		.file 9 "Drivers/STM32F4xx_HAL_Driver/Inc/stm32f4xx_hal_uart.h"
 1032              		.file 10 "Drivers/STM32F4xx_HAL_Driver/Inc/stm32f4xx_hal.h"
 1033              		.file 11 "Core/Inc/spi.h"
 1034              		.file 12 "Core/Inc/position_sensor.h"
 1035              		.file 13 "Core/Inc/foc.h"
 1036              		.file 14 "Core/Inc/calibration.h"
 1037              		.file 15 "Core/Inc/user_config.h"
 1038              		.file 16 "/usr/lib/gcc/arm-none-eabi/9.2.1/include/stddef.h"
 1039              		.file 17 "/usr/include/newlib/sys/_types.h"
 1040              		.file 18 "/usr/include/newlib/sys/reent.h"
 1041              		.file 19 "/usr/include/newlib/sys/lock.h"
 1042              		.file 20 "/usr/include/newlib/stdlib.h"
 1043              		.file 21 "Core/Inc/usart.h"
 1044              		.file 22 "/usr/include/newlib/math.h"
 1045              		.file 23 "/usr/include/newlib/stdio.h"
 1046              		.file 24 "<built-in>"
ARM GAS  /tmp/ccklse9U.s 			page 26


DEFINED SYMBOLS
                            *ABS*:0000000000000000 calibration.c
     /tmp/ccklse9U.s:18     .rodata.order_phases.str1.4:0000000000000000 $d
     /tmp/ccklse9U.s:36     .text.order_phases:0000000000000000 $t
     /tmp/ccklse9U.s:44     .text.order_phases:0000000000000000 order_phases
     /tmp/ccklse9U.s:308    .text.order_phases:0000000000000168 $d
     /tmp/ccklse9U.s:322    .rodata.calibrate_encoder.str1.4:0000000000000000 $d
     /tmp/ccklse9U.s:332    .text.calibrate_encoder:0000000000000000 $t
     /tmp/ccklse9U.s:339    .text.calibrate_encoder:0000000000000000 calibrate_encoder
     /tmp/ccklse9U.s:956    .text.calibrate_encoder:0000000000000398 $d
     /tmp/ccklse9U.s:976    .text.calibrate_encoder:00000000000003cc $t
     /tmp/ccklse9U.s:1002   .text.measure_lr:0000000000000000 $t
     /tmp/ccklse9U.s:1009   .text.measure_lr:0000000000000000 measure_lr

UNDEFINED SYMBOLS
__aeabi_f2d
__aeabi_d2uiz
reset_foc
round
puts
printf
commutate
__int_reg
__float_reg
